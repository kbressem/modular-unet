---

title: Utility functions


keywords: fastai
sidebar: home_sidebar

summary: "functions to manipulate and investigate nn.Modules"
description: "functions to manipulate and investigate nn.Modules"
nb_path: "nbs/utils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To Do</p>
<ul>
<li>[ ] Add permalink to fastai function</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Adapted-from-fastai">Adapted from fastai<a class="anchor-link" href="#Adapted-from-fastai"> </a></h2><p>I often use fastai to build and train models. However, the vision module of fastai is designed for 2d images. To work with 3d Modules most functions need small adjustments. Also, I wanted PyTorch as the only requirement for this repository. Therefore, I decided to transcribe the fastai functions and change them as needed. Still &gt;90% of the code is original fastai code and I try to appropriate credit.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Layer-manipulation">Layer manipulation<a class="anchor-link" href="#Layer-manipulation"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Access first layer of a model.<br>
Copied from: <a href="https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L25">https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L25</a></p>
<p><strong>Args</strong></p>
<table>
<thead><tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>model</td>
<td>nn.Module</td>
<td>A PyTorch model or Module</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong></p>
<table>
<thead><tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>child</td>
<td>nn.Module</td>
<td>The first module of the first model-layer</td>
</tr>
<tr>
<td>parent</td>
<td>nn.Sequential, None</td>
<td>The first layer of the model</td>
</tr>
<tr>
<td>name</td>
<td>str</td>
<td>The name of the first module</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Load pretrained weights based on number of input channels.<br>
Adapted from <a href="https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L33">https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L33</a>
Compared to the fastai function, this function can handle various number of input channels for the <code>previous_layer</code> and inits new channels in the <code>new_layer</code> with normal distribution not zero</p>
<p><strong>Args</strong></p>
<table>
<thead><tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>new_layer</td>
<td>nn.ConvNd</td>
<td>The new layer to transfer weights to</td>
</tr>
<tr>
<td>previous_layer</td>
<td>nn.ConvNd</td>
<td>The old layer to copy weights from</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong><br>
None (updates layer in place)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Change first layer based on number of input channels.<br>
Adapted from fastai implementation: <a href="https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L48">https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L48</a></p>
<p><strong>Args</strong></p>
<table>
<thead><tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>model</td>
<td>nn.Module</td>
<td>A PyTorch Model with first layer beeing a nn.Conv3d</td>
</tr>
<tr>
<td>in_channels</td>
<td>int</td>
<td>Number of input channels</td>
</tr>
<tr>
<td>pretrained</td>
<td>bool</td>
<td>Load pretrained weigths for the model (if available)</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong><br>
None (updates layer in place)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Return <code>True</code> if <code>module</code> is a pooling layer or has one in its children.<br>
Nearly identical to: <a href="https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L17">https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L17</a></p>
<p>*Args**</p>
<table>
<thead><tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>module</td>
<td>nn.Module</td>
<td>A PyTorch nn.Module or nn.Sequential</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong></p>
<p>bool</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_body" class="doc_header"><code>create_body</code><a href="https://github.com/kbressem/attention_unet/tree/main/attention_unet/utils.py#L62" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_body</code>(<strong><code>arch</code></strong>, <strong><code>in_channels</code></strong>, <strong><code>cut</code></strong>=<em><code>None</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Cut off the body of a typically pretrained <code>arch</code> as determined by <code>cut</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Cut off the body of a typically pretrained <code>arch</code> as determined by <code>cut</code>.<br>
Identical to: <a href="https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L63">https://github.com/fastai/fastai/blob/ecb67b8a3d322efeec1e3c37faa10025e5d22c49/fastai/vision/learner.py#L63</a></p>
<p><strong>Args</strong></p>
<table>
<thead><tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>arch</td>
<td>callable</td>
<td>Function to construct the model</td>
</tr>
<tr>
<td>in_channels</td>
<td>int</td>
<td>Number of input channels</td>
</tr>
<tr>
<td>cut</td>
<td>None, int, callable</td>
<td>If None, the position to cut of the body is determined automatically.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>If int, the model is cut at the specified position.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>If callabe, this function is used to cut the model</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong><br>
The body of the model</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="in_channels" class="doc_header"><code>in_channels</code><a href="https://github.com/kbressem/attention_unet/tree/main/attention_unet/utils.py#L78" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>in_channels</code>(<strong><code>module</code></strong>)</p>
</blockquote>
<p>Get the number of input_channels in the first weight layer in <code>module</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="first" class="doc_header"><code>first</code><a href="https://github.com/kbressem/attention_unet/tree/main/attention_unet/utils.py#L90" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>first</code>(<strong><code>x</code></strong>, <strong><code>f</code></strong>=<em><code>None</code></em>, <strong><code>negate</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>First element of <code>x</code>, optionally filtered by <code>f</code>, or None if missing</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dummy_eval" class="doc_header"><code>dummy_eval</code><a href="https://github.com/kbressem/attention_unet/tree/main/attention_unet/utils.py#L97" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dummy_eval</code>(<strong><code>m</code></strong>, <strong><code>size</code></strong>=<em><code>(8, 64, 64)</code></em>)</p>
</blockquote>
<p>Evaluate <code>m</code> on a dummy input of a certain <code>size</code>. Same as fastai func</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="model_sizes" class="doc_header"><code>model_sizes</code><a href="https://github.com/kbressem/attention_unet/tree/main/attention_unet/utils.py#L104" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>model_sizes</code>(<strong><code>m</code></strong>, <strong><code>size</code></strong>=<em><code>(8, 64, 64)</code></em>)</p>
</blockquote>
<p>Pass a dummy input through the model <code>m</code> to get the various sizes of activations. same as fastai func</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

